# 线程池

线程池的大小依赖于所执行任务的特性以及程序运行的环境，线程池的大小应该应采取可配置的方式（写入配置文件）或者根据可用的 cpu 数量 Runtime.availableProcessors()来进行设置。

一般情况下线程池大小的计算方法：

Ncpu 表示可用 cpu 数量

Nthreads 表示线程池工作线程数量

Ucpu 表示 cpu 的利用率 0≤Ucpu≤1

W 表示资源等待时间

C 表示任务计算时间

Rtotal 表示有限资源的总量

Rper 表示每个任务需要的资源数量

1.对于对于纯 cpu 计算的任务-即不依赖阻塞资源（外部接口调用）以及有限资源（线程池）的 cpu 密集型（compute-intensive）任务线程池的大小可以设置为

Nthreads = Ncpu+1

2.如果执行的任务除了 cpu 计算还包括一些外部接口调用或其他会阻塞的计算，那么线程池的大小可以设置为

Nthreads = Ncpu _ Ucpu _ （1 + W / C）

可以看出对于 IO 等待时间长于任务计算时间的情况，w/c 大于 1，假设 cpu 利用率是 100%，那么 w/c 结果越大，需要的工作线程也越多，因为如果没有足够的线程则会造成任务队列迅速膨胀。

3.如果任务依赖于一些有限的资源比如内存，文件句柄，数据库连接等等，那么线程池最大可以设置为

Nthreads ≤ Rtotal/Rper
