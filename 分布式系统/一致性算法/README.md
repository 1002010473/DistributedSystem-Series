# 一致性算法

一致性算法主要是解决分布式系统中多个节点之间对某个状态达成一致性结果的问题。分布式系统都是由多个服务节点共同完成对事务的处理，分布式系统中多个副本对外呈现的数据状态需要保持一致性。但是由于节点的不可靠性和节点间通讯的不稳定性，甚至节点作恶伪造信息进行恶意响应，节点之间就存在数据状态不一致性的问题。通过一致性算法，可以实现将多个不可靠的单独节点组建成一个可靠的分布式系统，实现数据状态的一致性，提高系统的可靠性。

一致性算法根据容错能力不同，即在考虑节点故障不响应的情况下，再考虑节点是否会伪造信息进行恶意响应，可以分为 CFT（Crash Fault Tolerance）类和 BFT（Byzantine Fault Tolerance）类一致性算法。

- CFT 一致性算法只保证分布式系统中节点发生宕机错误时整个分布式系统的可靠性，而当系统中节点违反共识协议的时候（比如被黑客攻占，数据被恶意篡改等）将无法保障分布式系统的可靠性，因此 CFT 一致性算法目前主要应用在企业内部的封闭式分布式系统中，目前流行的 CFT 一致性算法主要有 Paxos 算法及其衍生的 Raft 一致性算法。

- 采用 BFT 一致性算法的分布式系统，即使系统中的节点发生了任意类型的错误，只要发生错误的节点少于一定比例，整个系统的可靠性就可以保证。因此，在开放式分布式系统中，比如区块链网络，必须采用 BFT 一致性算法。

# 主流算法对比

Zookeeper 的 ZAB，Viewstamped Replication(VR)，Raft，Multi-Paxos，这些都可以被称之为 Leader-based 一致性协议。不同的是，Multi-Paxos Leader 是作为对经典 Paxos 的优化而提出，通过选择一个 Proposer 作为 Leader 降低多个 Proposer 引起冲突的频率，提升性能将一次决议的平均消息代价缩小到最优的两次，实际上就算有多个 Leader 存在，算法还是安全的，只是退化为经典的 Paxos 算法。

而经典的 Paxos，从一个提案被提出到被接受分为两个阶段，第一个阶段去询问值，第二阶段根据询问的结果提出值。这两个阶段是无法分割的，两个阶段的每个细节都是精心设计的，相互关联，共同保障了协议的一致性。

而 VR，ZAB，Raft 这些强调唯一的 Leader 的协议，它们直接从 Leader 的角度描述协议的流程，但是实际上它们使用了和 Paxos 完全一样的原理来保证协议的安全性，当同时存在多个节点同时尝试成为 Leader 或者多个节点都认为自己时 Leader 时，它们都可以视作是经典 Paxos 流程。 Paxos 和 Raft 都是一旦一个 entries(Raft 协议叫日志，paxos 叫提案)得到多数派的赞成，这个 entries 就会定下来，不丢失，值不更改，最终所有节点都会赞成它。
